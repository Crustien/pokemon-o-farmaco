<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PokÃƒÂ©mon o Farmaco?</title>
  <style>
    @font-face{
      font-family: "Pokemon Classic";
      src: url('font/Pokemon Classic.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    :root{
      --bg: #0f1226;
      --card:#171a35;
      --ink:#e9ecff;
      --muted:#9aa3d9;
      --accent:#6f8cff;
      --accent-2:#2ee6a6;
      --bad:#ff6b6b;
      --good:#25d29f;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --gb-green: #cbe6a3;
      --gb-green-dark: #3a5f3a;
      --gb-border: #0c230f;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      font: 16px/1.4 "Pokemon Classic", system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      color:var(--ink);
      background: radial-gradient(1200px 600px at 20% -10%, #203, transparent 60%), radial-gradient(900px 600px at 100% 0%, #032, transparent 60%), var(--bg);
      display:flex; align-items:center; justify-content:center;
      /* padding responsivo + safe areas (iOS notch) */
      --pad: clamp(16px, 2.5vw, 28px);
      padding: var(--pad);
      padding-left: calc(var(--pad) + env(safe-area-inset-left));
      padding-right: calc(var(--pad) + env(safe-area-inset-right));
      padding-top: calc(var(--pad) + env(safe-area-inset-top));
      padding-bottom: calc(var(--pad) + env(safe-area-inset-bottom));
    }

    .app{ width: min(900px, 100%); }
    header{ display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:18px; }
    .title{ display:flex; align-items:center; gap:12px;}
    .title .logo{ width:42px; height:42px; border-radius:12px; display:grid; place-items:center; background:linear-gradient(135deg, var(--accent), #00ffd0); box-shadow:var(--shadow); font-weight:700; color:#0a1530 }
    .title .logo img{ width:100%; height:100%; object-fit:contain; border-radius:inherit; display:block }
    h1{ font-size: clamp(18px, 2.5vw, 26px); margin:0; }

    .card{ background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border:1px solid #2a2e56; border-radius:var(--radius); box-shadow:var(--shadow); padding:24px; }
    .gb-window{ background:#0b1322; border-radius:12px; padding:20px; border:3px solid var(--gb-border); box-shadow:0 0 0 3px #223, inset 0 0 0 3px #223 }
    .gb-dialog{ background: var(--gb-green); color:#061a06; border:3px solid var(--gb-border); border-radius:6px; padding:10px 12px; box-shadow: inset 0 0 0 3px #8bbf6a }
    .grid{ display:grid; grid-template-columns: 1fr; gap:16px; }

    .name{
      text-align:center; font-weight:800; letter-spacing:0;
      font-size: clamp(28px, 6.5vw, 56px); margin:8px 0 4px;
      line-height:1.05; max-width:100%;
      overflow-wrap:anywhere; word-break:break-word;
    }
    .hint{ text-align:center; color:#061a06; font-size:14px; min-height:20px; display:inline-block; background:var(--gb-green); border:3px solid var(--gb-border); border-radius:6px; padding:10px 12px; box-shadow: inset 0 0 0 3px #8bbf6a; margin:8px auto 0 }

    .choices{ display:flex; gap:14px; justify-content:center; flex-wrap:wrap; margin-top:10px }
    .btn{ cursor:pointer; border:none; border-radius:14px; padding:16px 22px; 
      font-family: "Pokemon Classic", system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      font-weight:400; letter-spacing:0; 
      background:#11142b; color:var(--ink); border:1px solid #2a2e56; transition: transform .05s ease; }
    .btn:hover{ transform: translateY(-1px) }
    .btn:active{ transform: translateY(0) }
    .btn.primary{ background:linear-gradient(135deg, var(--accent), #00ffd0); color:#061225; border:none }
    .btn.good{ background: #07281f; border-color:#0e5; color:#8ff9d8 }
    .btn.bad{ background: #2b0e15; border-color:#f55; color:#ffc7c7 }
    .btn:disabled{ opacity:.6; cursor:not-allowed; pointer-events:none; filter:saturate(.85); }

    /* Bottoni stile Game Boy */
    .pixel-btn{ border-radius:6px; border:4px solid #000; background:#e5e5e5; color:#000; box-shadow: inset -4px -4px 0 rgba(0,0,0,.15); padding:16px 28px }
    .pixel-btn:hover{ transform:none; filter:brightness(1.02) }
    .gb-poke{ background:#ffd54a; color:#1a1300; border-color:#000 }
    .gb-drug{ background:#bde0ff; color:#04121f; border-color:#000 }
    .menu .pixel-btn{ width:min(360px, 90%); font-size:18px }
    .menu .pixel-btn .arrow{ margin-right:8px; animation: blink .8s steps(2,start) infinite }
    @keyframes blink{ 50%{ opacity:.2 } }

    .stats{ display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:12px; justify-items:stretch; color:var(--muted); margin-top:8px }
    .stat{ background:#0b0e20; border:1px solid #2a2e56; padding:10px 12px; border-radius:10px; min-width:110px; text-align:center; font-size:14px; overflow-wrap:anywhere; word-break:break-word }
    .stat b{ color:var(--ink); font-size:16px }

    .result{ text-align:center; margin-top:12px; min-height:26px }

    .pill{ display:inline-flex; align-items:center; gap:6px; border-radius:999px; padding:6px 10px; font-size:12px; background:#0b0e20; border:1px solid #2a2e56; color:var(--muted) }
    kbd{ background:#0b0e20; border:1px solid #2a2e56; border-bottom-width:2px; padding:2px 6px; border-radius:6px; font-family: "Pokemon Classic", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; color:var(--ink)}

    .muted{ color:var(--muted) }
    .hidden{ display:none !important }

    /* Timer bar */
    .timer{ gap:10px }
    .timer .bar{ width: clamp(140px, 28vw, 260px); height:8px; background:#0b0e20; border:1px solid #2a2e56; border-radius:999px; overflow:hidden }
    .timer .fill{ height:100%; width:100%; background:hsl(120 85% 55%); transition: width .1s linear, background-color .1s linear }

    /* Responsive tweaks */
    @media (max-width: 560px){
      header{ flex-direction: column; align-items: stretch; gap:10px }
      .choices{ flex-direction: column }
      .choices .btn{ width:100%; font-size:1rem; padding:16px 20px }
      .title .logo{ width:36px; height:36px }
      h1{ font-size: clamp(18px, 5vw, 22px) }
      .name{ font-size: clamp(24px, 10vw, 44px) }
      .stat{ min-width: 0 }
    }

    @media (min-width: 1100px){ .app{ width: min(1000px, 100%) } }
    /* Touch optimizations */
    .coarse .btn:hover{ transform:none }
    @media (pointer: coarse){ .btn{ padding:18px 24px } }
    .popup{ position:fixed; inset:0; display:grid; place-items:center; background: rgba(0,0,0,.35); z-index:50 }
    .popup .gb-dialog{ max-width: 520px }
    .popup.ok .gb-dialog{ background:#c3f7c3; box-shadow: inset 0 0 0 3px #74d874 }
    .popup.bad .gb-dialog{ background:#ffd1d1; box-shadow: inset 0 0 0 3px #ff8e8e }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <div class="logo"><img src="img/logo.png" alt="Logo"></div>
        <h1>PokÃƒÂ©mon o <span class="muted">Farmaco?</span></h1>
      </div>
    </header>
    
    <!-- Start screen -->
    <section id="startScreen" class="gb-window card">
      <div style="display:grid; place-items:center; gap:16px; text-align:center">
        <div class="logo" style="width:72px; height:72px"><img src="img/logo.png" alt="Logo"></div>
        <h1 style="margin:6px 0 12px">PokÃƒÂ©mon o <span class="muted">Farmaco?</span></h1>
        <div class="menu" style="display:grid; gap:12px; justify-items:center">
          <button id="startBtn" class="btn pixel-btn selected"><span class="arrow">Ã¢Å¾Â¤</span> Inizia</button>
          <button id="resetBtn" class="btn pixel-btn"><span class="arrow">Ã¢Å¾Â¤</span> Azzera statistiche</button>
        </div>
      </div>
    </section>

    <div class="grid hidden" id="gameScreen">
      <section class="card main">
        <div class="pill" id="roundPill">Round <b id="roundNum">1</b></div>
        <div class="pill timer" id="timerPill" role="progressbar" aria-label="Tempo rimasto" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100">
          <div class="bar"><div class="fill" id="timerBar" style="width:100%"></div></div>
        </div>
        <div class="name" id="name">Ã¢â‚¬â€</div>
        <div class="hint" id="hint">Scegli: farmaco o PokÃƒÂ©mon?</div>

        <div class="choices">
          <button class=" btn pixel-btn gb-drug\ id=\drugBtn\ type=\button\>?? Farmaco</button>
 <button class=\btn pixel-btn gb-poke\ id=\pokeBtn\ type=\button\>? PokÃ©mon</button>
        </div>

        <div class="result" id="result" aria-live="polite"></div>

        <div class="stats">
          <div class="stat">Corrette: <b id="correct">0</b></div>
          <div class="stat">Sbagliate: <b id="wrong">0</b></div>
          <div class="stat">Accuratezza: <b id="acc">0%</b></div>
          <div class="stat">Streak: <b id="streak">0</b> (max <b id="best">0</b>)</div>
        </div>
      </section>
    </div>
  </div>

  <div id=" popup\ class=\popup hidden\><div class=\gb-dialog\><div id=\popupText\></div></div></div>
  <script>
    // Dataset PokÃƒÂ©mon (Gen 1-9)
    const POKEMON = [
      // Gen 1
      {n:"Marowak", gen:1}, {n:"Vaporeon", gen:1}, {n:"Vulpix", gen:1}, {n:"Flareon", gen:1},
      // Gen 2
      {n:"Sentret", gen:2}, {n:"Ursaring", gen:2}, {n:"Umbreon", gen:2},
      // Gen 3
      {n:"Illumise", gen:3}, {n:"Manectric", gen:3}, {n:"Vibrava", gen:3}, {n:"Milotic", gen:3}, {n:"Altaria", gen:3}, {n:"Numel", gen:3}, {n:"Rayquaza", gen:3}, {n:"Absol", gen:3}, {n:"Nincada", gen:3}, {n:"Metang", gen:3}, {n:"Azurill", gen:3}, {n:"Groudon", gen:3},
      // Gen 4
      {n:"Gliscor", gen:4}, {n:"Roserade", gen:4}, {n:"Glaceon", gen:4}, {n:"Heatran", gen:4},
      // Gen 5
      {n:"Hydreigon", gen:5}, {n:"Reuniclus", gen:5}, {n:"Cofagrigus", gen:5}, {n:"Conkeldurr", gen:5}, {n:"Chandelure", gen:5}, {n:"Excadrill", gen:5}, {n:"Zoroark", gen:5}, {n:"Virizion", gen:5}, {n:"Terrakion", gen:5}, {n:"Cobalion", gen:5}, {n:"Keldeo", gen:5}, {n:"Meloetta", gen:5}, {n:"Genesect", gen:5},
      // Gen 6
      {n:"Greninja", gen:6}, {n:"Aegislash", gen:6}, {n:"Noivern", gen:6}, {n:"Goodra", gen:6}, {n:"Sylveon", gen:6}, {n:"Klefki", gen:6}, {n:"Trevenant", gen:6}, {n:"Xerneas", gen:6}, {n:"Yveltal", gen:6}, {n:"Zygarde", gen:6}, {n:"Carbink", gen:6}, {n:"Diancie", gen:6}, {n:"Hoopa", gen:6}, {n:"Volcanion", gen:6}, {n:"Aurorus", gen:6},
      // Gen 7 (rimossi i Tapu con spazio)
      {n:"Toxapex", gen:7}, {n:"Salazzle", gen:7}, {n:"Mimikyu", gen:7}, {n:"Bewear", gen:7}, {n:"Golisopod", gen:7}, {n:"Kommo-o", gen:7}, {n:"Nihilego", gen:7}, {n:"Buzzwole", gen:7}, {n:"Pheromosa", gen:7}, {n:"Xurkitree", gen:7}, {n:"Kartana", gen:7}, {n:"Celesteela", gen:7}, {n:"Stakataka", gen:7}, {n:"Blacephalon", gen:7}, {n:"Poipole", gen:7}, {n:"Naganadel", gen:7}, {n:"Zeraora", gen:7}, {n:"Vikavolt", gen:7},
      // Gen 8
      {n:"Zacian", gen:8}, {n:"Zamazenta", gen:8}, {n:"Eternatus", gen:8}, {n:"Toxtricity", gen:8}, {n:"Rillaboom", gen:8}, {n:"Cinderace", gen:8}, {n:"Inteleon", gen:8}, {n:"Corviknight", gen:8}, {n:"Dragapult", gen:8}, {n:"Duraludon", gen:8}, {n:"Coalossal", gen:8}, {n:"Falinks", gen:8}, {n:"Copperajah", gen:8}, {n:"Indeedee", gen:8}, {n:"Hatterene", gen:8}, {n:"Polteageist", gen:8}, {n:"Cursola", gen:8}, {n:"Perrserker", gen:8}, {n:"Alcremie", gen:8}, {n:"Urshifu", gen:8}, {n:"Regieleki", gen:8}, {n:"Regidrago", gen:8}, {n:"Calyrex", gen:8}, {n:"Spectrier", gen:8}, {n:"Glastrier", gen:8},
      // Gen 9 (rimossi nomi con spazio)
      {n:"Koraidon", gen:9}, {n:"Miraidon", gen:9}, {n:"Clodsire", gen:9}, {n:"Gholdengo", gen:9}, {n:"Ting-Lu", gen:9}, {n:"Chien-Pao", gen:9}, {n:"Chi-Yu", gen:9}, {n:"Wo-Chien", gen:9}, {n:"Kingambit", gen:9}, {n:"Tinkaton", gen:9}, {n:"Baxcalibur", gen:9}, {n:"Palafin", gen:9}, {n:"Orthworm", gen:9}, {n:"Lokix", gen:9}, {n:"Bombirdier", gen:9}, {n:"Tatsugiri", gen:9}, {n:"Veluza", gen:9}, {n:"Revavroom", gen:9}, {n:"Dachsbun", gen:9}, {n:"Grafaiai", gen:9}, {n:"Ceruledge", gen:9}, {n:"Armarouge", gen:9}, {n:"Glimmora", gen:9}, {n:"Ogerpon", gen:9}, {n:"Okidogi", gen:9}, {n:"Munkidori", gen:9}, {n:"Fezandipiti", gen:9}, {n:"Terapagos", gen:9}, {n:"Pecharunt", gen:9}
    ];

    // Farmaci (nomi commerciali, deduplicati)
    const DRUGS = [
      {n:"Ozempic"}, {n:"Wegovy"}, {n:"Rybelsus"}, {n:"Mounjaro"}, {n:"Zepbound"}, {n:"Trulicity"}, {n:"Januvia"}, {n:"Jardiance"}, {n:"Farxiga"},
      {n:"Humira"}, {n:"Enbrel"}, {n:"Remicade"}, {n:"Stelara"}, {n:"Cosentyx"}, {n:"Skyrizi"}, {n:"Taltz"}, {n:"Dupixent"}, {n:"Xolair"},
      {n:"Keytruda"}, {n:"Opdivo"}, {n:"Tagrisso"}, {n:"Ibrance"}, {n:"Kisqali"}, {n:"Imbruvica"}, {n:"Darzalex"}, {n:"Xtandi"},
      {n:"Xarelto"}, {n:"Eliquis"}, {n:"Entresto"}, {n:"Xifaxan"}, {n:"Biktarvy"}, {n:"Descovy"}, {n:"Truvada"}, {n:"Genvoya"},
      {n:"Veklury"}, {n:"Paxlovid"}, {n:"Tamiflu"}, {n:"Lagevrio"},
      {n:"Aimovig"}, {n:"Ajovy"}, {n:"Emgality"}, {n:"Nurtec"}, {n:"Ubrelvy"}, {n:"Qulipta"},
      {n:"Trintellix"}, {n:"Cymbalta"}, {n:"Lyrica"}, {n:"Viibryd"}, {n:"Pristiq"},
      {n:"Olumiant"}, {n:"Otezla"}, {n:"Rinvoq"}, {n:"Xeljanz"},
      {n:"Arexvy"}, {n:"Abrysvo"},
      {n:"Opsumit"}, {n:"Uptravi"}, {n:"Adempas"}, {n:"Aranesp"}, {n:"Rozerem"}, {n:"Voltaren"}, {n:"Actos"}, {n:"Ticlid"}, {n:"Qvar"}, {n:"Crestor"}, {n:"Decadron"}, {n:"Tygacil"}, {n:"Geodon"}, {n:"Clasteon"}, {n:"Finasteride"}, {n:"Minoxidil"}, {n:"Cialis"}, {n:"Tadalafil"}, {n:"Deursil"}, {n:"Botox"}, {n:"Bisoprololo"},
      // Aggiunte dalla foto
      {n:"Luxiq"}, {n:"Banzel"}, {n:"Xigris"}, {n:"Carnitor"}, {n:"Aceon"}, {n:"Jalyn"}, {n:"Navane"}, {n:"Fuzeon"}, {n:"Rescriptor"}
    ];

    const els = {
      name: document.getElementById('name'),
      hint: document.getElementById('hint'),
      result: document.getElementById('result'),
      correct: document.getElementById('correct'),
      wrong: document.getElementById('wrong'),
      acc: document.getElementById('acc'),
      streak: document.getElementById('streak'),
      best: document.getElementById('best'),
      round: document.getElementById('roundNum'),
      timerPill: document.getElementById('timerPill'),
      timerBar: document.getElementById('timerBar'),
    };

    const drugBtn = document.getElementById('drugBtn');
    const pokeBtn = document.getElementById('pokeBtn');

    const MAX_WRONG = 5;
    const TIME_LIMIT_MS = 5000;
    let gameOver = false;
    let replayBtn = null;
    let inputLocked = false;
    let tStart = 0;
    let tInterval = null;
    let tTimeout = null;

    let deck = [];
    let idx = -1;
    const state = { correct: 0, wrong: 0, streak: 0, best: 0, round: 0 };

    // localStorage for persistence
    const SAVEK = 'pf_stats_v1';
    const saved = JSON.parse(localStorage.getItem(SAVEK) || 'null');
    if(saved){ Object.assign(state, saved); }

    function save(){ localStorage.setItem(SAVEK, JSON.stringify(state)); }

    function buildDeck(){
      const items = [
        ...POKEMON.map(p=>({ name:p.n, type:'pokemon', info:`PokÃƒÂ©mon (Gen ${p.gen})` })),
        ...DRUGS.map(d=>({ name:d.n, type:'drug', info:`Farmaco` }))
      ];
      // Shuffle (FisherÃ¢â‚¬â€œYates)
      for(let i=items.length-1; i>0; i--){
        const j = Math.floor(Math.random()* (i+1));
        [items[i], items[j]] = [items[j], items[i]];
      }
      deck = items; idx = -1;
    }

    function next(){
      if(deck.length===0 || idx>=deck.length-1) buildDeck();
      idx++;
      state.round++; save();
      updateStatsUI();
      const cur = deck[idx];
      els.name.textContent = cur.name;
      els.hint.textContent = 'Farmaco o PokÃƒÂ©mon?';
      els.result.textContent = '';
      if(!gameOver){
        inputLocked = false;
        drugBtn.disabled = false; pokeBtn.disabled = false;
        startTimer();
      }
    }

    function updateStatsUI(){
      els.round.textContent = state.round;
      els.correct.textContent = state.correct;
      els.wrong.textContent = state.wrong;
      const total = state.correct + state.wrong;
      const acc = total? Math.round((state.correct/total)*100): 0;
      els.acc.textContent = acc+"%";
      els.streak.textContent = state.streak;
      els.best.textContent = state.best;
    }

    function flash(btn, ok){
      btn.classList.remove('good','bad');
      void btn.offsetWidth; // reflow
      btn.classList.add(ok? 'good':'bad');
      setTimeout(()=>btn.classList.remove('good','bad'), 300);
    }

    function clearTimer(){
      if(tInterval){ clearInterval(tInterval); tInterval = null; }
      if(tTimeout){ clearTimeout(tTimeout); tTimeout = null; }
    }

    function updateTimerUI(ms){
      if(!els.timerBar || !els.timerPill) return;
      const pct = Math.max(0, Math.min(1, ms / TIME_LIMIT_MS));
      els.timerBar.style.width = (pct*100).toFixed(1)+'%';
      const hue = Math.round(120 * pct); // 120=verde, 0=rosso
      els.timerBar.style.background = `hsl(${hue} 85% 55%)`;
      els.timerPill.setAttribute('aria-valuenow', String(Math.round(pct*100)));
    }

    function startTimer(){
      clearTimer();
      tStart = Date.now();
      updateTimerUI(TIME_LIMIT_MS);
      tInterval = setInterval(()=>{
        const left = Math.max(0, TIME_LIMIT_MS - (Date.now() - tStart));
        updateTimerUI(left);
        if(left <= 0){ clearTimer(); timeUp(); }
      }, 100);
      tTimeout = setTimeout(()=>{ clearTimer(); timeUp(); }, TIME_LIMIT_MS + 20);
    }

    function timeUp(){
      if (gameOver || inputLocked) return;
      inputLocked = true;
      drugBtn.disabled = true; pokeBtn.disabled = true;
      const cur = deck[idx];
      state.wrong++;
      state.streak = 0;
      els.result.innerHTML = `Ã¢ÂÂ±Ã¯Â¸Â Tempo scaduto! <b>${cur.name}</b> ÃƒÂ¨ ${cur.type==='drug' ? 'un <b>farmaco</b>' : 'un <b>PokÃƒÂ©mon</b>'}. <span class="muted">${cur.info||''}</span>`;
      updateStatsUI();
      if (state.wrong >= MAX_WRONG) {
        setTimeout(endGame, 400);
      } else {
        setTimeout(next, 1400);
      }
      save();
    }

    function answer(choice){
      if (gameOver || inputLocked) return;
      const cur = deck[idx];
      const ok = cur.type === choice;

      // blocca input durante il feedback per evitare doppio click
      inputLocked = true;
      drugBtn.disabled = true; pokeBtn.disabled = true;
      clearTimer();

      if (ok) {
        state.correct++;
        state.streak++;
        state.best = Math.max(state.best, state.streak);
        els.result.innerHTML = `Ã¢Å“â€¦ Esatto! <b>${cur.name}</b> ÃƒÂ¨ ${cur.type==='drug' ? 'un <b>farmaco</b>' : 'un <b>PokÃƒÂ©mon</b>'}. <span class="muted">${cur.info||''}</span>`;
        showPopup("wild Pokemon defeated!", true); beep(880,120,"square");
        flash(choice==='drug' ? drugBtn : pokeBtn, true);
        updateStatsUI();
        setTimeout(next, 1400);
      } else {
        state.wrong++;
        state.streak = 0;
        els.result.innerHTML = `Ã¢ÂÅ’ No! <b>${cur.name}</b> ÃƒÂ¨ ${cur.type==='drug' ? 'un <b>farmaco</b>' : 'un <b>PokÃƒÂ©mon</b>'}. <span class="muted">${cur.info||''}</span>`;
        flash(choice==='drug' ? drugBtn : pokeBtn, false);
        showPopup("It's super effective...", false); beep(220,160,"square");
        updateStatsUI();
        if (state.wrong >= MAX_WRONG) {
          setTimeout(endGame, 400);
        } else {
          setTimeout(next, 1400);
        }
      }
      save();
    }

    function endGame(){
      gameOver = true;
      inputLocked = true;
      clearTimer();
      const total = state.correct + state.wrong;
      const acc = total ? Math.round((state.correct/total)*100) : 0;
      els.name.textContent = 'Fine!';
      els.hint.textContent = `Hai esaurito i ${MAX_WRONG} tentativi`;
      els.result.innerHTML = `Ã°Å¸Â§Â  Partita terminata.<br>Corrette: <b>${state.correct}</b> Ã¢â‚¬Â¢ Sbagliate: <b>${state.wrong}</b> Ã¢â‚¬Â¢ Accuratezza: <b>${acc}%</b> Ã¢â‚¬Â¢ Streak max: <b>${state.best}</b>`;
      drugBtn.disabled = true; pokeBtn.disabled = true;
      drugBtn.classList.add('hidden');
      pokeBtn.classList.add('hidden');
      if(!replayBtn){
        replayBtn = document.createElement('button');
        replayBtn.id = 'replayBtn';
        replayBtn.className = 'btn primary';
        replayBtn.type = 'button';
        replayBtn.textContent = 'Rigioca';
        replayBtn.addEventListener('click', replay);
      }
      const choicesEl = document.querySelector('.choices');
      if(choicesEl && !choicesEl.contains(replayBtn)) choicesEl.appendChild(replayBtn);
      // Nascondi lo stats box (ridondante nella schermata finale)
      const statsEl = document.querySelector('.stats');
      if (statsEl) statsEl.classList.add('hidden');
    }

    function replay(){
      // resetta la run ma mantiene il best
      const bestKeep = state.best;
      Object.assign(state, { correct: 0, wrong: 0, streak: 0, best: bestKeep, round: 0 });
      gameOver = false;
      inputLocked = false;
      clearTimer();
      const choicesEl = document.querySelector('.choices');
      if(replayBtn && choicesEl && choicesEl.contains(replayBtn)) choicesEl.removeChild(replayBtn);
      drugBtn.disabled = false; pokeBtn.disabled = false;
      drugBtn.classList.remove('hidden');
      pokeBtn.classList.remove('hidden');
      // Mostra di nuovo lo stats box alla nuova partita
      (function(){ const statsEl = document.querySelector('.stats'); if (statsEl) statsEl.classList.remove('hidden'); })();
      els.result.textContent = '';
      els.hint.textContent = 'Scegli: farmaco o PokÃƒÂ©mon?';
      buildDeck();
      idx = -1;
      updateStatsUI();
      save();
      next();
    }

    // Event wiring (click)
    drugBtn.addEventListener('click', ()=>answer('drug'));
    pokeBtn.addEventListener('click', ()=>answer('pokemon'));


    
    // --- Start screen & popup ---
    const startEl = document.getElementById('startScreen');
    const gameEl = document.getElementById('gameScreen');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const popupEl = document.getElementById('popup');
    const popupText = document.getElementById('popupText');

    function showStart(){
      clearTimer();
      gameOver = false; inputLocked = true;
      if(startEl) startEl.classList.remove('hidden');
      if(gameEl) gameEl.classList.add('hidden');
    }
    function startFromMenu(){
      if(startEl) startEl.classList.add('hidden');
      if(gameEl) gameEl.classList.remove('hidden');
      const bestKeep = state.best;
      Object.assign(state, { correct: 0, wrong: 0, streak: 0, best: bestKeep, round: 0 });
      save(); updateStatsUI();
      idx = -1; buildDeck(); gameOver = false; inputLocked = false; next();
    }
    function resetStats(){
      Object.assign(state, { correct:0, wrong:0, streak:0, best:0, round:0 });
      save(); updateStatsUI();
    }

    if(startBtn){ startBtn.addEventListener('click', startFromMenu); }
    if(resetBtn){ resetBtn.addEventListener('click', resetStats); }

    function showPopup(text, good){
      if(!popupEl) return;
      popupText.textContent = text;
      popupEl.classList.remove('hidden');
      popupEl.classList.toggle('ok', !!good);
      popupEl.classList.toggle('bad', !good);
      setTimeout(()=>{ if(popupEl) popupEl.classList.add('hidden'); }, 900);
    }
    function beep(freq=880, duration=120, type='square'){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = type; o.frequency.value = freq; o.connect(g); g.connect(ctx.destination);
        o.start(); g.gain.setValueAtTime(0.12, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + duration/1000);
        setTimeout(()=>{ o.stop(); ctx.close(); }, duration+50);
      }catch(e){}
    }
    // Responsive: detect coarse pointer and toggle class
    (function(){
      const mq = window.matchMedia('(pointer: coarse)');
      const apply = ()=> document.body.classList.toggle('coarse', mq.matches);
      apply();
      if(mq.addEventListener) mq.addEventListener('change', apply); else mq.addListener(apply);
    })();
    // Boot
    // Boot
    buildDeck();
    updateStatsUI();
    showStart();
</body>
</html>

